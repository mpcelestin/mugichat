{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8">
            <!-- Stream Player Section -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3>{{ stream.title }}</h3>
                    <p class="mb-0">Streaming by 
                        <a href="{{ url_for('user_posts', username=stream.user.username) }}" 
                           class="text-white">{{ stream.user.username }}</a>
                    </p>
                </div>
                <div class="card-body">
                    <div class="ratio ratio-16x9">
                        <video id="stream-player" class="video-js" controls autoplay>
                            <source src="/stream/{{ stream.stream_key }}" type="application/x-mpegURL">
                        </video>
                    </div>
                    <div class="mt-2">
                        <span id="viewer-count-{{ stream.id }}" class="badge bg-secondary">
                            <i class="bi bi-people-fill"></i> {{ stream.viewers_count }} viewers
                        </span>
                        {% if stream.user_id == current_user.id %}
                        <form method="POST" action="{{ url_for('end_stream', stream_id=stream.id) }}" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-danger btn-sm float-end">End Stream</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stream Chat Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Stream Chat</h5>
                </div>
                <div class="card-body p-0">
                    <div id="stream-chat-messages" 
                         style="height: 300px; overflow-y: auto; padding: 15px;">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="border-top p-2">
                        <form id="stream-chat-form">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="stream-chat-input" 
                                       placeholder="Type a message..."
                                       autocomplete="off">
                                <button class="btn btn-primary" type="submit">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize video player
        const player = videojs('stream-player');
        
        // Join the stream chat room
        socket.emit('join_stream_chat', { stream_id: {{ stream.id }} });
        
        // Handle chat form submission
        const chatForm = document.getElementById('stream-chat-form');
        const chatInput = document.getElementById('stream-chat-input');
        const chatMessages = document.getElementById('stream-chat-messages');
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            
            if (message) {
                socket.emit('stream_chat_message', {
                    stream_id: {{ stream.id }},
                    message: message
                });
                chatInput.value = '';
                chatInput.focus();
            }
        });
        
        // Handle incoming messages
        socket.on('new_stream_message', function(data) {
            if (data.stream_id == {{ stream.id }}) {
                const isCurrentUser = data.user_id == {{ current_user.id }};
                const messageElement = document.createElement('div');
                messageElement.className = `mb-3 ${isCurrentUser ? 'text-end' : 'text-start'}`;
                
                messageElement.innerHTML = `
                    <div class="d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'} align-items-center mb-1">
                        ${!isCurrentUser ? `
                        <img src="/static/profile_pics/${data.profile_pic}" 
                             class="rounded-circle me-2" width="24" height="24">
                        ` : ''}
                        <strong>${data.username}</strong>
                        ${isCurrentUser ? `
                        <img src="/static/profile_pics/${data.profile_pic}" 
                             class="rounded-circle ms-2" width="24" height="24">
                        ` : ''}
                    </div>
                    <div class="${isCurrentUser ? 'bg-primary text-white' : 'bg-light'} p-2 rounded d-inline-block">
                        ${data.message}
                        <div class="text-${isCurrentUser ? 'white-50' : 'muted'} small mt-1">
                            ${new Date(data.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
        
        // Leave room when page is unloaded
        window.addEventListener('beforeunload', function() {
            socket.emit('leave_stream_chat', { stream_id: {{ stream.id }} });
        });
    });
</script>
{% endblock %}